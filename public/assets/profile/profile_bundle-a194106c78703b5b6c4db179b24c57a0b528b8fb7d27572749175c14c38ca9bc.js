"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}();!function(t){var e=/^.*[\\\/]/,i=function(){function t(e){var i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=i.filename,n=i.previewImage,o=i.modalCrop,r=i.pickImageEl,s=i.uploadImageBtn,l=i.modalCropImg,u=i.exportWidth,h=void 0===u?200:u,c=i.exportHeight,d=void 0===c?200:c,p=i.cropBoxWidth,m=void 0===p?200:p,f=i.cropBoxHeight,g=void 0===f?200:f;_classCallCheck(this,t),this.onUploadImageBtnClick=this.onUploadImageBtnClick.bind(this),this.onModalHide=this.onModalHide.bind(this),this.onModalShow=this.onModalShow.bind(this),this.onPickImageClick=this.onPickImageClick.bind(this),this.fileInput=$(e),this.modalCropImg=_.isString(this.modalCropImg)?$(this.modalCropImg):this.modalCropImg,this.fileInput.attr("name",this.fileInput.attr("name")+"-trigger").attr("id","this.fileInput.attr('id')-trigger"),this.exportWidth=h,this.exportHeight=d,this.cropBoxWidth=m,this.cropBoxHeight=g,this.form=this.fileInput.parents("form"),this.filename=a,this.previewImage=n,this.modalCrop=o,this.pickImageEl=r,this.uploadImageBtn=s,this.modalCropImg=l,this.filename=this.getElement(a),this.previewImage=this.getElement(n),this.pickImageEl=this.getElement(r),this.modalCrop=_.isString(o)?$(o):o,this.uploadImageBtn=_.isString(s)?$(s):s,this.modalCropImg=_.isString(l)?$(l):l,this.cropActionsBtn=this.modalCrop.find("[data-method]"),this.bindEvents()}return _createClass(t,[{key:"getElement",value:function(t){return $(t,this.form)}},{key:"bindEvents",value:function(){var t;return t=this,this.fileInput.on("change",function(e){return t.onFileInputChange(e,this)}),this.pickImageEl.on("click",this.onPickImageClick),this.modalCrop.on("shown.bs.modal",this.onModalShow),this.modalCrop.on("hidden.bs.modal",this.onModalHide),this.uploadImageBtn.on("click",this.onUploadImageBtnClick),this.cropActionsBtn.on("click",function(e){var i;return i=this,t.onActionBtnClick(i)}),this.croppedImageBlob=null}},{key:"onPickImageClick",value:function(){return this.fileInput.trigger("click")}},{key:"onModalShow",value:function(){var t;return t=this,this.modalCropImg.cropper({viewMode:1,center:!1,aspectRatio:1,modal:!0,scalable:!1,rotatable:!1,zoomable:!0,dragMode:"move",guides:!1,zoomOnTouch:!1,zoomOnWheel:!1,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1,built:function(){var e,i,a,n;return e=$(this),i=e.cropper("getContainerData"),n=t.cropBoxWidth,a=t.cropBoxHeight,e.cropper("setCropBoxData",{width:n,height:a,left:(i.width-n)/2,top:(i.height-a)/2})}})}},{key:"onModalHide",value:function(){return this.modalCropImg.attr("src","").cropper("destroy")}},{key:"onUploadImageBtnClick",value:function(t){return t.preventDefault(),this.setBlob(),this.setPreview(),this.modalCrop.modal("hide"),this.fileInput.val("")}},{key:"onActionBtnClick",value:function(t){var e,i;return e=$(t).data(),this.modalCropImg.data("cropper")&&e.method?i=this.modalCropImg.cropper(e.method,e.option):void 0}},{key:"onFileInputChange",value:function(t,e){return this.readFile(e)}},{key:"readFile",value:function(t){var e,i;return e=this,i=new FileReader,i.onload=function(){return e.modalCropImg.attr("src",i.result),e.modalCrop.modal("show")},i.readAsDataURL(t.files[0])}},{key:"dataURLtoBlob",value:function(t){var e,i,a,n,o,r;for(i=atob(t.split(",")[1]),e=[],n=a=0,o=i.length;o>a;n=++a)r=i[n],e.push(i.charCodeAt(n));return new Blob([new Uint8Array(e)],{type:"image/png"})}},{key:"setPreview",value:function(){var t;return this.previewImage.attr("src",this.dataURL),t=this.fileInput.val().replace(e,""),this.filename.text(t)}},{key:"setBlob",value:function(){return this.dataURL=this.modalCropImg.cropper("getCroppedCanvas",{width:200,height:200}).toDataURL("image/png"),this.croppedImageBlob=this.dataURLtoBlob(this.dataURL)}},{key:"getBlob",value:function(){return this.croppedImageBlob}}]),t}();$.fn.glCrop=function(t){return this.each(function(){return $(this).data("glcrop",new i(this,t))})}}(window.gl||(window.gl={}));var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}();!function(t){var e=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=e.form;_classCallCheck(this,t),this.onSubmitForm=this.onSubmitForm.bind(this),this.form=i||$(".edit-user"),this.bindEvents(),this.initAvatarGlCrop()}return _createClass(t,[{key:"initAvatarGlCrop",value:function(){var t={filename:".js-avatar-filename",previewImage:".avatar-image .avatar",modalCrop:".modal-profile-crop",pickImageEl:".js-choose-user-avatar-button",uploadImageBtn:".js-upload-user-avatar",modalCropImg:".modal-profile-crop-image"};this.avatarGlCrop=$(".js-user-avatar-input").glCrop(t).data("glcrop")}},{key:"bindEvents",value:function(){$(".js-preferences-form").on("change.preference","input[type=radio]",this.submitForm),$("#user_notification_email").on("change",this.submitForm),$(".update-username").on("ajax:before",this.beforeUpdateUsername),$(".update-username").on("ajax:complete",this.afterUpdateUsername),$(".update-notifications").on("ajax:success",this.onUpdateNotifs),this.form.on("submit",this.onSubmitForm)}},{key:"submitForm",value:function(){return $(this).parents("form").submit()}},{key:"onSubmitForm",value:function(t){return t.preventDefault(),this.saveForm()}},{key:"beforeUpdateUsername",value:function(){return $(".loading-username").show(),$(this).find(".update-success").hide(),$(this).find(".update-failed").hide()}},{key:"afterUpdateUsername",value:function(){return $(".loading-username").hide(),$(this).find(".btn-save").enable(),$(this).find(".loading-gif").hide()}},{key:"onUpdateNotifs",value:function(t,e){return e.saved?new Flash("Notification settings saved","notice"):new Flash("Failed to save new settings","alert")}},{key:"saveForm",value:function(){var t=this,e=new FormData(this.form[0]),i=this.avatarGlCrop.getBlob();return null!=i&&e.append("user[avatar]",i,"avatar.png"),$.ajax({url:this.form.attr("action"),type:this.form.attr("method"),data:e,dataType:"json",processData:!1,contentType:!1,success:function(t){return new Flash(t.message,"notice")},error:function(t){return new Flash(t.responseJSON.message,"alert")},complete:function(){return window.scrollTo(0,0),t.form.find(":input[disabled]").enable()}})}}]),t}();$(function(){return $(document).on("focusout.ssh_key","#key_key",function(){var t=$("#key_title"),e=$(this).val().match(/^\S+ \S+ (.+)\n?$/);return e&&e.length>1&&""===t.val()?t.val(e[1]).change():void 0}),"profiles"===t.utils.getPagePath()?new e:void 0})}(window.gl||(window.gl={})),function(){}.call(this);